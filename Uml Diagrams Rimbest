# ğŸ¨ RimbestArch â€” Guide Expert UML Complet
> **Stack:** Spring Boot 3 REST API Â· Angular 20 Â· MySQL Â· JWT Security  
> **Domaine:** RÃ©servation hÃ´teliÃ¨re multi-rÃ´les (Client, Partenaire, Admin)

---

## ğŸ“Œ Vue d'ensemble de l'architecture

```
Angular 20 (SPA)
      â”‚  HTTP/JWT (Bearer Token)
      â–¼
Spring Boot REST API
      â”‚
      â”œâ”€â”€ Security (Spring Security + JWT)
      â”œâ”€â”€ Controllers (REST Endpoints)
      â”œâ”€â”€ Services (Business Logic)
      â”œâ”€â”€ Repositories (Spring Data JPA)
      â””â”€â”€ MySQL Database
```

---

## 1ï¸âƒ£  DIAGRAMME DE CAS D'UTILISATION

### ğŸ­ Acteurs

| Acteur | Description |
|--------|-------------|
| **Visiteur** | Utilisateur non authentifiÃ© |
| **Client** | Utilisateur inscrit qui rÃ©serve des chambres |
| **Partenaire** | PropriÃ©taire d'hÃ´tels, gÃ¨re son catalogue |
| **Administrateur** | Supervise tout le systÃ¨me |
| **SystÃ¨me (Timer)** | TÃ¢che schedulÃ©e qui expire les rÃ©servations |

### ğŸ“‹ Cas d'utilisation par acteur

#### Visiteur (non connectÃ©)
- UC-01 : Consulter la liste des hÃ´tels
- UC-02 : Rechercher des hÃ´tels (ville, dates, capacitÃ©)
- UC-03 : Voir les dÃ©tails d'un hÃ´tel et de ses chambres
- UC-04 : S'inscrire (en tant que Client **ou** Partenaire)
- UC-05 : Se connecter

#### Client (hÃ©rite de Visiteur)
- UC-06 : CrÃ©er une rÃ©servation de chambre
- UC-07 : Consulter ses rÃ©servations
- UC-08 : Annuler une rÃ©servation *(EN_ATTENTE)*
- UC-09 : Voir les dÃ©tails d'une rÃ©servation (imprimer)
- UC-10 : GÃ©rer son profil (modifier, changer mot de passe)
- UC-11 : Recevoir des notifications
- UC-12 : Consulter son tableau de bord personnel

#### Partenaire (hÃ©rite de Visiteur)
- UC-13 : Ajouter / Modifier / Supprimer un hÃ´tel
- UC-14 : GÃ©rer les chambres de ses hÃ´tels (CRUD)
- UC-15 : Modifier la disponibilitÃ© d'une chambre
- UC-16 : Voir les rÃ©servations de ses hÃ´tels
- UC-17 : Changer le statut d'une rÃ©servation (CONFIRMER / ANNULER)
- UC-18 : CrÃ©er une offre promotionnelle sur une chambre
- UC-19 : Consulter les statistiques de ses hÃ´tels (revenus, taux d'occupation)
- UC-20 : GÃ©rer son profil entreprise

#### Administrateur (hÃ©rite de Visiteur + accÃ¨s total)
- UC-21 : GÃ©rer tous les utilisateurs (liste, crÃ©er, modifier, activer/dÃ©sactiver)
- UC-22 : GÃ©rer tous les hÃ´tels (tous partenaires confondus)
- UC-23 : GÃ©rer toutes les rÃ©servations
- UC-24 : Activer / DÃ©sactiver un hÃ´tel
- UC-25 : Voir les statistiques globales du systÃ¨me
- UC-26 : Voir les statistiques par partenaire / par utilisateur

#### SystÃ¨me (Scheduler)
- UC-27 : Expirer automatiquement les rÃ©servations (`ReservationTaskService`)
- UC-28 : Mettre Ã  jour les chambres disponibles aprÃ¨s fin de sÃ©jour
- UC-29 : Envoyer des notifications automatiques aux clients/partenaires

---

### PlantUML â€” Diagramme de Cas d'Utilisation

```plantuml
@startuml RimbestArch_UseCases
left to right direction
skinparam actorStyle awesome
skinparam packageStyle rectangle

actor "Visiteur" as V
actor "Client" as C
actor "Partenaire" as P
actor "Administrateur" as A
actor "SystÃ¨me (Scheduler)" as S

C --|> V
P --|> V
A --|> V

package "ğŸ”“ AccÃ¨s Public" {
  usecase "Voir liste hÃ´tels\n(UC-01)" as UC01
  usecase "Rechercher hÃ´tels\n(UC-02)" as UC02
  usecase "Voir dÃ©tails hÃ´tel/chambre\n(UC-03)" as UC03
  usecase "S'inscrire\n(UC-04)" as UC04
  usecase "Se connecter\n(UC-05)" as UC05
}

package "ğŸ‘¤ Espace Client" {
  usecase "CrÃ©er rÃ©servation\n(UC-06)" as UC06
  usecase "Consulter rÃ©servations\n(UC-07)" as UC07
  usecase "Annuler rÃ©servation\n(UC-08)" as UC08
  usecase "Voir dÃ©tails rÃ©servation\n(UC-09)" as UC09
  usecase "GÃ©rer profil\n(UC-10)" as UC10
  usecase "Recevoir notifications\n(UC-11)" as UC11
  usecase "Tableau de bord client\n(UC-12)" as UC12
}

package "ğŸ¨ Espace Partenaire" {
  usecase "GÃ©rer hÃ´tels (CRUD)\n(UC-13)" as UC13
  usecase "GÃ©rer chambres\n(UC-14)" as UC14
  usecase "DisponibilitÃ© chambre\n(UC-15)" as UC15
  usecase "Voir rÃ©servations hÃ´tel\n(UC-16)" as UC16
  usecase "Changer statut rÃ©servation\n(UC-17)" as UC17
  usecase "Offres promotionnelles\n(UC-18)" as UC18
  usecase "Statistiques partenaire\n(UC-19)" as UC19
}

package "âš™ï¸ Espace Admin" {
  usecase "GÃ©rer utilisateurs\n(UC-21)" as UC21
  usecase "GÃ©rer tous les hÃ´tels\n(UC-22)" as UC22
  usecase "GÃ©rer toutes rÃ©servations\n(UC-23)" as UC23
  usecase "Activer/DÃ©sactiver hÃ´tel\n(UC-24)" as UC24
  usecase "Statistiques globales\n(UC-25)" as UC25
}

package "ğŸ¤– TÃ¢ches Automatiques" {
  usecase "Expirer rÃ©servations\n(UC-27)" as UC27
  usecase "LibÃ©rer chambres\n(UC-28)" as UC28
  usecase "Envoyer notifications\n(UC-29)" as UC29
}

V --> UC01
V --> UC02
V --> UC03
V --> UC04
V --> UC05

C --> UC06
C --> UC07
C --> UC08
C --> UC09
C --> UC10
C --> UC11
C --> UC12

P --> UC13
P --> UC14
P --> UC15
P --> UC16
P --> UC17
P --> UC18
P --> UC19

A --> UC21
A --> UC22
A --> UC23
A --> UC24
A --> UC25

S --> UC27
S --> UC28
S --> UC29

UC06 ..> UC03 : <<include>>
UC09 ..> UC07 : <<include>>
UC17 ..> UC16 : <<include>>
UC27 ..> UC29 : <<include>>
UC28 ..> UC27 : <<include>>
@enduml
```

---

## 2ï¸âƒ£  DIAGRAMME DE CLASSE

### ğŸ—‚ï¸ EntitÃ©s et leurs attributs complets

#### HiÃ©rarchie d'hÃ©ritage (`JOINED` strategy)

```
User (users)
â”œâ”€â”€ Client (clients)        â€” ROLE_CLIENT
â”œâ”€â”€ Partenaire (partenaires) â€” ROLE_PARTENAIRE
â””â”€â”€ Administrator (administrators) â€” ROLE_ADMIN
```

### PlantUML â€” Diagramme de Classe

```plantuml
@startuml RimbestArch_ClassDiagram
skinparam classAttributeIconSize 0
skinparam classFontSize 13
skinparam classBackgroundColor #F8F9FA
skinparam classBorderColor #495057
skinparam packageBackgroundColor #E9ECEF
skinparam arrowColor #343A40

' â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ENUMERATIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
enum StatutReservation {
  EN_ATTENTE
  CONFIRMEE
  ANNULEE
  TERMINEE
  EXPIREE
}

enum StatutPaiement {
  EN_ATTENTE
  PAYE
  REMBOURSE
  ECHEC
}

enum ERole {
  ROLE_CLIENT
  ROLE_PARTENAIRE
  ROLE_ADMIN
}

' â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ CORE ENTITIES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
package "Utilisateurs" {
  abstract class User {
    - id : Long
    - nom : String
    - email : String
    - motDePasse : String
    - telephone : String
    - adresse : String
    - actif : Boolean
    - createdAt : Date
    - updatedAt : Date
    + getUserType() : String
  }

  class Client {
    ' hÃ©rite tous les champs de User
    ' Table: clients (PK = user_id)
  }

  class Partenaire {
    - nomEntreprise : String
    - siret : String
    - adresseEntreprise : String
    - telephonePro : String
    - siteWeb : String
    - description : String
    - verified : Boolean
    - commissionRate : Double
  }

  class Administrator {
    ' hÃ©rite tous les champs de User
    ' Table: administrators (PK = user_id)
  }

  class Role {
    - id : Integer
    - name : ERole
  }
}

package "HÃ´tels & Chambres" {
  class Hotel {
    - id : Long
    - nom : String
    - ville : String
    - pays : String
    - quartier : String
    - etoiles : Integer (1â€“5)
    - description : String
    - adresse : String
    - telephone : String
    - email : String
    - equipementsHotel : String
    - latitude : Double
    - longitude : Double
    - noteMoyenne : Double
    - nombreAvis : Integer
    - imagesUrls : String
    - prixMinimumIndication : Double
    - actif : Boolean
    - createdAt : LocalDateTime
    - updatedAt : LocalDateTime
    + getNombreChambresDisponibles() : int
    + getPrixMinimum() : Double
  }

  class Chambre {
    - id : Long
    - numero : String
    - typeChambre : String
    - capacite : Integer
    - prixNuit : Double
    - description : String
    - superficie : Double
    - equipementsChambre : String
    - vueType : String
    - nombreLits : Integer
    - typeLits : String
    - prixWeekend : Double
    - taxeSejour : Double
    - depotGarantie : Double
    - imagesChambre : String
    - salleBainPrivee : Boolean
    - climatisation : Boolean
    - television : Boolean
    - wifi : Boolean
    - minibar : Boolean
    - coffreFort : Boolean
    - disponible : Boolean
    - statutNettoyage : String
    - createdAt : LocalDateTime
    - updatedAt : LocalDateTime
    + getFirstImageUrl() : String
  }
}

package "RÃ©servations & Paiements" {
  class Reservation {
    - id : Long
    - reference : String
    - dateArrivee : LocalDate
    - dateDepart : LocalDate
    - nombrePersonnes : Integer
    - statut : StatutReservation
    - prixTotal : BigDecimal
    - reduction : BigDecimal
    - depotGarantie : BigDecimal
    - modePaiement : String
    - statutPaiement : StatutPaiement
    - createdAt : Date
    - updatedAt : Date
  }

  class Paiement {
    - id : Long
    - reference : String
    - montant : BigDecimal
    - methodePaiement : String
    - statut : String
    - datePaiement : LocalDateTime
    - details : String
  }

  class OffrePromotionnelle {
    - id : Long
    - nomOffre : String
    - dateDebut : LocalDate
    - dateFin : LocalDate
    - prixPromo : BigDecimal
    - description : String
  }
}

package "Notifications" {
  class Notification {
    - id : Long
    - message : String
    - read : Boolean
    - createdAt : LocalDateTime
    - type : NotificationType
  }

  enum NotificationType {
    INFO
    SUCCESS
    WARNING
    DANGER
  }
}

' â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ RELATIONS D'HÃ‰RITAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
User <|-- Client
User <|-- Partenaire
User <|-- Administrator

' â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ASSOCIATIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
User "1" *-- "0..*" Role : roles (ManyToMany)
User "1" *-- "0..*" Notification : reÃ§oit (ManyToOne)

Partenaire "1" *-- "0..*" Hotel : possÃ¨de (ManyToOne)
Hotel "1" *-- "1..*" Chambre : contient (OneToMany)
Chambre "1" *-- "0..*" Reservation : fait l'objet de (OneToMany)
Chambre "1" *-- "0..*" OffrePromotionnelle : a (OneToMany)
User "1" *-- "0..*" Reservation : effectue (ManyToOne)
Reservation "1" *-- "0..*" Paiement : gÃ©nÃ¨re (OneToMany)

' â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ENUM USAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Reservation --> StatutReservation
Reservation --> StatutPaiement
Role --> ERole
Notification --> NotificationType
@enduml
```

---

## 3ï¸âƒ£  DIAGRAMMES DE SÃ‰QUENCE

Neuf scÃ©narios couvrant l'ensemble des flux mÃ©tier de l'application.

---

### ğŸ“Œ SÃ©quence 1 â€” Authentification JWT (Login)

**Acteurs :** Client/Partner/Admin â†’ Angular â†’ Spring Boot â†’ MySQL

```plantuml
@startuml Sequence_Login
skinparam sequenceMessageAlign center
skinparam responseMessageBelowArrow true

actor "Utilisateur" as U
participant "Angular\nLoginComponent" as FE
participant "AuthService\n(Angular)" as AS
participant "AuthRestController\n(Spring)" as BE
participant "UserDetailsServiceImpl" as UDS
participant "JwtUtils" as JWT
database "MySQL" as DB

U -> FE : Saisir email + motDePasse
FE -> AS : login(credentials)
AS -> BE : POST /api/auth/login\n{email, motDePasse}
BE -> UDS : loadUserByUsername(email)
UDS -> DB : SELECT * FROM users WHERE email = ?
DB --> UDS : UserDetails
UDS --> BE : UserDetails

BE -> BE : AuthenticationManager\n.authenticate()
BE -> JWT : generateJwtToken(userDetails)
JWT --> BE : token (JWT String)

BE --> AS : {token, role, userId, nom}
AS -> AS : localStorage.setItem('token', ...)
AS --> FE : AuthResponse
FE -> FE : Router.navigate()\nâ†’ /dashboard/{role}
FE --> U : Tableau de bord affichÃ©

note right of JWT
  JWT contient:
  - subject: email
  - roles: [ROLE_CLIENT]
  - expiry: 24h
end note
@enduml
```

---

### ğŸ“Œ SÃ©quence 2 â€” CrÃ©ation d'une RÃ©servation (Flux complet)

**Acteur :** Client â†’ Angular â†’ Spring Boot â†’ MySQL + Notification

```plantuml
@startuml Sequence_Reservation
skinparam sequenceMessageAlign center
skinparam responseMessageBelowArrow true

actor "Client" as C
participant "Angular\nAddReservationComponent" as FE
participant "ReservationService\n(Angular)" as RS
participant "AppInterceptor\n(JWT header)" as INT
participant "ReservationRestController" as BE
participant "ReservationService\n(Spring)" as SVC
participant "ChambreService" as CS
participant "NotificationService" as NS
database "MySQL" as DB

C -> FE : Choisir chambre + dates\n+ nombre personnes
FE -> FE : Calculer prixTotal\n= prixNuit Ã— nbJours
FE -> RS : createReservation(reservationDTO)
RS -> INT : Ajouter header\nAuthorization: Bearer {token}
INT -> BE : POST /api/reservations\n{chambreId, dateArrivee,\ndateDepart, nombrePersonnes}

BE -> SVC : createReservation(dto, clientId)
SVC -> CS : findById(chambreId)
CS -> DB : SELECT * FROM chambres WHERE id = ?
DB --> CS : Chambre
CS --> SVC : Chambre

SVC -> SVC : VÃ©rifier disponibilitÃ©\n(pas de conflits dates)
SVC -> SVC : GÃ©nÃ©rer rÃ©fÃ©rence:\n"RES-{timestamp}-{rand}"
SVC -> DB : INSERT INTO reservations\n(statut=EN_ATTENTE, ...)
DB --> SVC : Reservation sauvÃ©e

SVC -> NS : sendNotification(client,\n"RÃ©servation crÃ©Ã©e", SUCCESS)
NS -> DB : INSERT INTO notifications
SVC -> NS : sendNotification(partenaire,\n"Nouvelle rÃ©servation", INFO)
NS -> DB : INSERT INTO notifications
SVC --> BE : ReservationDTO

BE --> RS : HTTP 201 {reservationId, reference}
RS --> FE : RÃ©servation crÃ©Ã©e
FE -> FE : Router.navigate()\nâ†’ /reservations/{id}
FE --> C : Page confirmation avec rÃ©fÃ©rence

note over SVC
  Statut initial: EN_ATTENTE
  Le partenaire doit CONFIRMER
  ou le scheduler expire aprÃ¨s dÃ©lai
end note
@enduml
```

---

### ğŸ“Œ SÃ©quence 3 â€” Gestion HÃ´tel par un Partenaire (CRUD Hotel + Chambre)

```plantuml
@startuml Sequence_GestionHotel
skinparam sequenceMessageAlign center

actor "Partenaire" as P
participant "Angular\nHotelAddComponent" as FE
participant "HotelService\n(Angular)" as HS
participant "HotelRestController" as BE
participant "HotelService\n(Spring)" as SVC
participant "FileStorageService" as FS
database "MySQL" as DB

P -> FE : Remplir formulaire hÃ´tel\n+ uploader images
FE -> HS : createHotel(formData)
HS -> BE : POST /api/hotels\n(multipart/form-data)\n[ROLE_PARTENAIRE requis]

BE -> BE : VÃ©rifier JWT + role\n(ROLE_PARTENAIRE || ROLE_ADMIN)
BE -> FS : storeFiles(imageFiles)
FS -> FS : Sauvegarder dans /uploads/hotels/
FS --> BE : imageUrls[]

BE -> SVC : saveHotel(hotel, partenaireId, imageUrls)
SVC -> SVC : hotel.setPartenaire(user)
SVC -> SVC : hotel.setImagesUrls(join(",",...))
SVC -> DB : INSERT INTO hotels
DB --> SVC : Hotel (id gÃ©nÃ©rÃ©)
SVC --> BE : HotelDTO

BE --> HS : HTTP 201 {hotel}
HS --> FE : Hotel crÃ©Ã©
FE --> P : Redirection vers\n/hotel/details/{id}

P -> FE : Ajouter une Chambre
FE -> BE : POST /api/chambres/{hotelId}\n{numero, typeChambre, prixNuit, ...}
BE -> BE : VÃ©rifier ownership\n(hotel.partenaire == currentUser)
BE -> DB : INSERT INTO chambres\n(hotel_id = {hotelId})
DB --> BE : Chambre sauvÃ©e
BE --> FE : ChambreDTO
FE --> P : Chambre ajoutÃ©e avec succÃ¨s

note right of BE
  Ownership check:
  hotel.partenaire.id == JWT.userId
  OU user has ROLE_ADMIN
end note
@enduml
```

---

### ğŸ“Œ SÃ©quence 4 â€” Gestion des Utilisateurs par l'Admin (CRUD)

**Acteur :** Administrateur â†’ Angular â†’ `UserRestController` â†’ `UserService` â†’ MySQL  
Route protÃ©gÃ©e : `@PreAuthorize("hasRole('ADMIN')")`

```plantuml
@startuml Sequence_GestionUtilisateurs
skinparam sequenceMessageAlign center
skinparam responseMessageBelowArrow true

actor "Administrateur" as A
participant "Angular\nUsersComponent" as FE
participant "UserService\n(Angular)" as US
participant "AppInterceptor\n(JWT header)" as INT
participant "UserRestController\n(Spring)" as BE
participant "UserService\n(Spring)" as SVC
database "MySQL" as DB

== Lister les utilisateurs ==
A -> FE : AccÃ©der Ã  /admin/users
FE -> US : getUsers(page, size, search, role, active)
US -> INT : Ajouter Authorization: Bearer {token}
INT -> BE : GET /api/admin/users\n?page=0&size=10&search=...&role=CLIENT
BE -> BE : @PreAuthorize("hasRole('ADMIN')")
BE -> DB : SELECT * FROM users\nWHERE nom LIKE ? OR email LIKE ?\nORDER BY id DESC
DB --> BE : Page<User>
BE -> BE : Filtrer par role, actif\n(in-memory)
BE --> US : HTTP 200 Page<UserResponse>
US --> FE : Liste paginÃ©e
FE --> A : Tableau des utilisateurs

== CrÃ©er un utilisateur ==
A -> FE : Cliquer "Nouveau" â†’ /admin/users/create
FE -> FE : Choisir rÃ´le:\nCLIENT / PARTENAIRE / ADMIN
A -> FE : Soumettre formulaire
FE -> BE : POST /api/admin/users\n{nom, email, role, motDePasse, ...}
BE -> SVC : switch(role)\n  ROLE_CLIENT â†’ registerClient()\n  ROLE_PARTENAIRE â†’ registerPartenaire()\n  ROLE_ADMIN â†’ registerAdministrator()
SVC -> SVC : BCrypt.encode(motDePasse)
SVC -> DB : INSERT INTO users\nINSERT INTO {clients|partenaires|administrators}\nINSERT INTO user_roles
DB --> SVC : User crÃ©Ã© (id)
SVC --> BE : User
BE --> FE : HTTP 201 UserResponse
FE --> A : Utilisateur crÃ©Ã© âœ“

== Activer / DÃ©sactiver un utilisateur ==
A -> FE : Toggle switch "Actif"
FE -> BE : PATCH /api/admin/users/{id}/status\n{activate: true|false}
BE -> SVC : findById(id)
SVC -> DB : SELECT * FROM users WHERE id = ?
DB --> SVC : User
SVC --> BE : User
BE -> BE : user.setActif(request.isActivate())
BE -> SVC : updateUser(id, user)
SVC -> DB : UPDATE users SET actif = ? WHERE id = ?
DB --> SVC : OK
SVC --> BE : User mis Ã  jour
BE --> FE : HTTP 200 UserResponse
FE --> A : Statut mis Ã  jour âœ“

== Supprimer un utilisateur ==
A -> FE : Cliquer "Supprimer"
FE -> BE : DELETE /api/admin/users/{id}
BE -> SVC : deleteUser(id)
SVC -> DB : DELETE FROM users WHERE id = ?
DB --> SVC : OK
SVC --> BE : true
BE --> FE : HTTP 204 No Content
FE --> A : Utilisateur supprimÃ© âœ“

note right of BE
  Tous les endpoints sous
  /api/admin/users requiÃ¨rent:
  ROLE_ADMIN dans le JWT
end note
@enduml
```

---

### ğŸ“Œ SÃ©quence 5 â€” Confirmation / Refus d'une RÃ©servation (Partenaire)

**Acteur :** Partenaire â†’ `ReservationRestController` â†’ `ReservationService` + `NotificationService`

```plantuml
@startuml Sequence_StatutReservation
skinparam sequenceMessageAlign center
skinparam responseMessageBelowArrow true

actor "Partenaire" as P
participant "Angular\nReservationListComponent" as FE
participant "ReservationService\n(Angular)" as RS
participant "ReservationRestController" as BE
participant "ReservationService\n(Spring)" as SVC
participant "NotificationService" as NS
participant "ChambreService" as CS
database "MySQL" as DB

P -> FE : Voir rÃ©servations EN_ATTENTE\n(/reservations/partenaire)
FE -> BE : GET /api/reservations?page=0\n[ROLE_PARTENAIRE]
BE -> BE : Extraire user depuis JWT
BE -> SVC : getReservationsByPartenaire(user)
SVC -> DB : SELECT r.* FROM reservations r\nJOIN chambres c ON r.chambre_id=c.id\nJOIN hotels h ON c.hotel_id=h.id\nWHERE h.partenaire_id = ?
DB --> SVC : List<Reservation>
SVC --> BE : Page<ReservationDTO>
BE --> FE : HTTP 200 Liste
FE --> P : Liste des rÃ©servations en attente

== CONFIRMER une rÃ©servation ==
P -> FE : Cliquer "Confirmer" sur rÃ©servation
FE -> BE : PUT /api/reservations/{id}/statut\n{activate: true}
BE -> SVC : confirmReservation(id)
SVC -> DB : SELECT * FROM reservations WHERE id = ?
DB --> SVC : Reservation (statut=EN_ATTENTE)
SVC -> SVC : reservation.setStatut(CONFIRMEE)
SVC -> DB : UPDATE reservations\nSET statut='CONFIRMEE', updated_at=NOW()\nWHERE id = ?
DB --> SVC : OK
SVC -> CS : chambre.setDisponible(false)
CS -> DB : UPDATE chambres SET disponible=false\nWHERE id = ?
SVC -> NS : createNotification(client,\n"RÃ©servation confirmÃ©e!", SUCCESS)
NS -> DB : INSERT INTO notifications
SVC --> BE : ReservationDTO
BE --> FE : HTTP 200 {statut: "CONFIRMEE"}
FE --> P : RÃ©servation confirmÃ©e âœ“

== REFUSER une rÃ©servation ==
P -> FE : Cliquer "Refuser"
FE -> BE : PUT /api/reservations/{id}/statut\n{activate: false}
BE -> SVC : refuseReservation(id, "AnnulÃ©e via API")
SVC -> SVC : reservation.setStatut(ANNULEE)
SVC -> DB : UPDATE reservations SET statut='ANNULEE'
SVC -> CS : chambre.setDisponible(true)
CS -> DB : UPDATE chambres SET disponible=true
SVC -> NS : createNotification(client,\n"RÃ©servation refusÃ©e", WARNING)
NS -> DB : INSERT INTO notifications
SVC --> BE : ReservationDTO
BE --> FE : HTTP 200 {statut: "ANNULEE"}
FE --> P : RÃ©servation refusÃ©e âœ“

note over SVC
  Cycle de vie complet:
  EN_ATTENTE â†’ CONFIRMEE â†’ TERMINEE (scheduler)
  EN_ATTENTE â†’ ANNULEE (refus/annulation)
end note
@enduml
```

---

### ğŸ“Œ SÃ©quence 6 â€” Recherche d'HÃ´tels (Visiteur / Client)

**Acteur :** Visiteur â†’ `SearchComponent` â†’ `HotelSearchController` â†’ `HotelSearchService`

```plantuml
@startuml Sequence_Recherche
skinparam sequenceMessageAlign center
skinparam responseMessageBelowArrow true

actor "Visiteur" as V
participant "Angular\nSearchComponent" as FE
participant "HotelSearchService\n(Angular)" as HS
participant "HotelSearchController\n(Spring)" as BE
participant "HotelSearchService\n(Spring)" as SVC
database "MySQL" as DB

V -> FE : Saisir: ville, dates,\ncapacitÃ©, Ã©toiles, prix
FE -> FE : Debounce (300ms)\n+ validation formulaire

== AutocomplÃ©tion ==
V -> FE : Taper "Casa..."
FE -> BE : GET /api/search/autocomplete?q=Casa
BE -> SVC : searchAutocomplete("Casa")
SVC -> DB : SELECT DISTINCT ville FROM hotels\nWHERE ville LIKE 'Casa%' AND actif=true
DB --> SVC : ["Casablanca", "Casanet"]
SVC --> BE : List<String>
BE --> FE : HTTP 200 suggestions[]
FE --> V : Dropdown suggestions

== Recherche principale ==
V -> FE : Soumettre formulaire de recherche
FE -> HS : searchHotels(searchDTO)
HS -> BE : GET /api/search?\nville=Casablanca&dateArrivee=2026-03-01\n&dateDepart=2026-03-07&capacite=2\n&etoiles=4&prixMin=500&prixMax=2000
BE -> SVC : searchHotels(HotelSearchDTO, pageable)
SVC -> DB : SELECT h.* FROM hotels h\nJOIN chambres c ON c.hotel_id = h.id\nWHERE h.ville = ? AND h.actif = true\nAND h.etoiles >= ?\nAND c.prixNuit BETWEEN ? AND ?\nAND c.capacite >= ?\nAND c.disponible = true\nAND NOT EXISTS (rÃ©servations conflictuelles)\nGROUP BY h.id
DB --> SVC : List<Hotel>
SVC -> SVC : convertToHotelCardDTO(hotel)\n(premiere image, prixMin, rating)
SVC --> BE : Page<HotelCardDTO>
BE --> HS : HTTP 200 {content[], totalPages, totalElements}
HS --> FE : RÃ©sultats paginÃ©s
FE --> V : Liste des hÃ´tels avec\nprix, Ã©toiles, images

== Filtres dynamiques ==
V -> FE : Modifier filtre prix
FE -> BE : GET /api/search/filters?\n(mÃªmes params)
BE -> SVC : getFilterOptions(searchDTO)
SVC -> DB : COUNT hotels par Ã©toiles,\nMIN/MAX prix, Ã©quipements
DB --> SVC : FilterOptionsDTO
BE --> FE : HTTP 200 {priceRange, starCounts,...}
FE --> V : Mise Ã  jour des filtres

note right of SVC
  HotelSearchService exclut automatiquement
  les chambres avec rÃ©servations
  CONFIRMEE sur la pÃ©riode demandÃ©e
end note
@enduml
```

---

### ğŸ“Œ SÃ©quence 7 â€” Tableau de Bord (Dashboard par rÃ´le)

**Acteurs :** Client/Partenaire/Admin â†’ `DashboardController` â†’ `DashboardService`

```plantuml
@startuml Sequence_Dashboard
skinparam sequenceMessageAlign center
skinparam responseMessageBelowArrow true

actor "Utilisateur" as U
participant "Angular\nDashboardComponent" as FE
participant "DashboardService\n(Angular)" as DS
participant "DashboardController\n(Spring)" as BE
participant "DashboardService\n(Spring)" as SVC
database "MySQL" as DB

U -> FE : Naviguer vers /dashboard
FE -> FE : Lire rÃ´le depuis\nlocalStorage / JWT
FE -> FE : Router.navigate()\nâ†’ /dashboard/admin\nâ†’ /dashboard/partenaire\nâ†’ /dashboard/client

== Cas Admin ==
FE -> BE : GET /api/dashboard/admin\n[ROLE_ADMIN]
BE -> SVC : getAdminStats()
SVC -> DB : COUNT hotels (total + actif)
SVC -> DB : COUNT users total
SVC -> DB : COUNT reservations total + EN_ATTENTE
SVC -> DB : COUNT clients, partenaires par rÃ´le
SVC -> DB : SUM prixTotal (revenus total + mois)
SVC -> DB : getRevenueByMonth (6 derniers mois)
SVC -> DB : findAll reservations ORDER BY DESC LIMIT 8
DB --> SVC : DashboardResponse
SVC --> BE : {stats: {...}, lastReservations: [...]}
BE --> FE : HTTP 200 DashboardResponse
FE --> U : KPIs + graphique revenus\n+ tableau derniÃ¨res rÃ©servations

== Cas Partenaire ==
FE -> BE : GET /api/dashboard/partenaire\n[ROLE_PARTENAIRE]
BE -> BE : Extraire user (partenaire) depuis JWT
BE -> SVC : getPartenaireStats(partenaire)
SVC -> DB : COUNT hotels WHERE partenaire_id = ?
SVC -> DB : COUNT chambres total + disponibles\n(via hotels du partenaire)
SVC -> DB : findAll reservations\npar hÃ´tels du partenaire
SVC -> DB : SUM revenus total + mois courant
SVC -> DB : SUM revenus mois prÃ©cÃ©dent\n(pour calcul croissance %)
DB --> SVC : DashboardResponse
SVC --> BE : {myHotels, revenus, growth%, chambres...}
BE --> FE : HTTP 200 DashboardResponse
FE --> U : Stats hÃ´tels + taux croissance\n+ derniÃ¨res rÃ©servations

== Cas Client ==
FE -> BE : GET /api/dashboard/client\n[ROLE_CLIENT]
BE -> BE : Extraire user (client) depuis JWT
BE -> SVC : getClientStats(client)
SVC -> DB : findByClient(client)\nâ†’ reservations total + EN_ATTENTE
SVC -> DB : findRecommendedHotels\n(4 hÃ´tels actifs au hasard)
DB --> SVC : DashboardResponse
SVC --> BE : {totalReservations, pending, recommended}
BE --> FE : HTTP 200 DashboardResponse
FE --> U : Mes rÃ©servations + hÃ´tels recommandÃ©s

note right of SVC
  DashboardService agrÃ¨ge plusieurs
  repositories en une seule rÃ©ponse
  pour minimiser les requÃªtes HTTP
  depuis Angular
end note
@enduml
```

---

### ğŸ“Œ SÃ©quence 8 â€” Expiration Automatique des RÃ©servations (Scheduler)

**Acteur :** `@Scheduled` Cron + `ApplicationReadyEvent` â†’ `ReservationTaskService`

```plantuml
@startuml Sequence_Scheduler
skinparam sequenceMessageAlign center
skinparam responseMessageBelowArrow true

participant "Spring\nApplication\nContext" as APP
participant "ReservationTaskService\n(@Scheduled)" as TASK
participant "ReservationRepository" as REPO
participant "NotificationService" as NS
database "MySQL" as DB

== Au dÃ©marrage de l'application ==
APP -> TASK : @EventListener(ApplicationReadyEvent)
TASK -> TASK : onApplicationReady()\nâ†’ checkExpiredReservations()

== ExÃ©cution quotidienne (minuit) ==
APP -> TASK : @Scheduled(cron="0 0 0 * * ?")\nCheckExpiredReservations()
TASK -> TASK : today = LocalDate.now()

TASK -> REPO : findByStatutAndDateDepartBefore\n(CONFIRMEE, today)
REPO -> DB : SELECT * FROM reservations\nWHERE statut='CONFIRMEE'\nAND date_depart < CURDATE()
DB --> REPO : List<Reservation> expirÃ©es
REPO --> TASK : List<Reservation>

loop Pour chaque rÃ©servation expirÃ©e
  TASK -> REPO : updateStatut(id, TERMINEE)
  REPO -> DB : UPDATE reservations\nSET statut='TERMINEE'\nWHERE id = ?
  DB --> REPO : OK

  TASK -> DB : UPDATE chambres SET disponible=true\nWHERE id = {chambre_id}

  TASK -> NS : createNotification(client,\n"Votre sÃ©jour {REF} est terminÃ©.", SUCCESS)
  NS -> DB : INSERT INTO notifications\n(user_id=client, type=SUCCESS)

  TASK -> NS : createNotification(partenaire,\n"SÃ©jour {client} terminÃ©.\nChambre {num} disponible.", INFO)
  NS -> DB : INSERT INTO notifications\n(user_id=partenaire, type=INFO)

  TASK -> REPO : save(reservation)
  REPO -> DB : COMMIT transaction
end

TASK -> TASK : log.info("{N} rÃ©servations\nterminÃ©es.")

note over TASK
  Cron: "0 0 0 * * ?"
  ExÃ©cution: chaque jour Ã  00:00:00
  @Transactional garantit l'atomicitÃ©
  de chaque expiration
end note
@enduml
```

---

### ğŸ“Œ SÃ©quence 9 â€” Modification du Profil Utilisateur

**Acteur :** Utilisateur â†’ `ProfileRestController` â†’ `UserService`  
Valable pour Client, Partenaire (champs entreprise) et Admin

```plantuml
@startuml Sequence_ModificationProfil
skinparam sequenceMessageAlign center
skinparam responseMessageBelowArrow true

actor "Utilisateur" as U
participant "Angular\nProfileEditComponent" as FE
participant "ProfileService\n(Angular)" as PS
participant "ProfileRestController\n(Spring)" as BE
participant "UserService\n(Spring)" as SVC
database "MySQL" as DB

== Charger le profil ==
U -> FE : Naviguer vers /profile/edit
FE -> BE : GET /api/profile\n[Authorization: Bearer {token}]
BE -> BE : Extraire email depuis JWT
BE -> SVC : findByEmail(email)
SVC -> DB : SELECT u.*, p.*, a.*\nFROM users u\nLEFT JOIN partenaires p ON p.user_id=u.id\nLEFT JOIN administrators a ON a.user_id=u.id\nWHERE u.email = ?
DB --> SVC : User (polymorphe)
SVC --> BE : UserResponse (avec getUserType())
BE --> FE : HTTP 200 {nom, email, telephone,\nnomEntreprise, siret, ...}
FE --> U : Formulaire prÃ©-rempli

== Modifier le profil ==
U -> FE : Modifier champs + soumettre
FE -> FE : Validation (email unique,\ntÃ©lÃ©phone format, etc.)
FE -> BE : PUT /api/profile\n{nom, email, telephone, adresse,\nnomEntreprise?, siret?, ...}
BE -> SVC : findByEmail(currentEmail)
SVC -> DB : SELECT * FROM users WHERE email=?
DB --> SVC : User existant
SVC --> BE : User
BE -> BE : Mise Ã  jour champs communs\n(nom, email, tÃ©lÃ©phone, adresse)
BE -> BE : if(user instanceof Partenaire)\n  â†’ setNomEntreprise()\n  â†’ setSiret()\n  â†’ setAdresseEntreprise()
BE -> SVC : updateUser(id, user)
SVC -> DB : UPDATE users SET nom=?, email=?,\ntelephone=?, updated_at=NOW()\nWHERE id = ?
DB --> SVC : OK (si Partenaire)
SVC -> DB : UPDATE partenaires SET\nnom_entreprise=?, siret=?\nWHERE user_id = ?
DB --> SVC : OK
SVC --> BE : User mis Ã  jour
BE --> FE : HTTP 200 UserResponse
FE --> U : Profil mis Ã  jour âœ“

== Changer le mot de passe ==
U -> FE : Naviguer vers /profile/password
FE -> BE : PUT /api/profile/password\n{ancienMotDePasse, nouveauMotDePasse}
BE -> BE : passwordEncoder.matches\n(ancien, storedHash)
alt Ancien MDP correct
  BE -> BE : passwordEncoder.encode(nouveau)
  BE -> SVC : updatePassword(id, hashedNew)
  SVC -> DB : UPDATE users SET mot_de_passe=?\nWHERE id = ?
  DB --> SVC : OK
  SVC --> BE : OK
  BE --> FE : HTTP 200 "Mot de passe mis Ã  jour"
  FE --> U : âœ“ SuccÃ¨s
else Ancien MDP incorrect
  BE --> FE : HTTP 400 "Ancien mot de passe incorrect"
  FE --> U : âœ— Erreur
end

note right of BE
  JWT ne contient pas le mot de passe.
  L'utilisateur doit se reconnecter
  aprÃ¨s changement de mot de passe
  si le token expire.
end note
@enduml
```

---

## ğŸ—ºï¸ RÃ©capitulatif de tous les Diagrammes de SÃ©quence

| # | ScÃ©nario | Acteurs principaux | Endpoint(s) clÃ© |
|---|----------|--------------------|-----------------|
| **Seq-1** | Authentification JWT | Utilisateur â†’ Angular â†’ Spring Security | `POST /api/auth/login` |
| **Seq-2** | CrÃ©ation rÃ©servation | Client â†’ REST â†’ MySQL + Notif | `POST /api/reservations` |
| **Seq-3** | Gestion hÃ´tel/chambre | Partenaire â†’ REST â†’ FileStorage | `POST /api/hotels`, `POST /api/chambres/{id}` |
| **Seq-4** | Gestion utilisateurs | Admin â†’ CRUD Users | `GET/POST/PUT/PATCH/DELETE /api/admin/users` |
| **Seq-5** | Confirmation rÃ©servation | Partenaire â†’ Statut â†’ Notif | `PUT /api/reservations/{id}/statut` |
| **Seq-6** | Recherche hÃ´tels | Visiteur â†’ Search + Autocomplete | `GET /api/search?...` |
| **Seq-7** | Tableau de bord | Tous rÃ´les â†’ Stats agrÃ©gÃ©es | `GET /api/dashboard/{role}` |
| **Seq-8** | Expiration automatique | `@Scheduled` cron quotidien | (interne Spring) |
| **Seq-9** | Modification profil | Utilisateur â†’ ProfileRest | `GET/PUT /api/profile` |

---

## ğŸ”‘ RÃ©capitulatif des Relations JPA (pour le diagramme de classe)

| Relation | Source | Cible | Type | Colonne FK |
|----------|--------|-------|------|------------|
| Partenaire possÃ¨de | `Hotel` | `Partenaire (User)` | `@ManyToOne` | `partenaire_id` |
| HÃ´tel contient | `Chambre` | `Hotel` | `@ManyToOne` | `hotel_id` |
| Client fait | `Reservation` | `User (client)` | `@ManyToOne` | `client_id` |
| RÃ©servation sur | `Reservation` | `Chambre` | `@ManyToOne` | `chambre_id` |
| Paiement liÃ© Ã  | `Paiement` | `Reservation` | `@ManyToOne` | `reservation_id` |
| Offre sur | `OffrePromotionnelle` | `Chambre` | `@ManyToOne` | `chambre_id` |
| Notification vers | `Notification` | `User` | `@ManyToOne` | `user_id` |
| User a des rÃ´les | `User` | `Role` | `@ManyToMany` | `user_roles` |

---

## âš™ï¸ Services Spring Boot (Ã  placer dans le diagramme de classe Ã©tendu)

| Service | ResponsabilitÃ© principale |
|---------|--------------------------|
| `UserService` | Inscription, authentification, gestion utilisateurs |
| `HotelService` | CRUD hÃ´tels, activation/dÃ©sactivation |
| `ChambreService` | CRUD chambres, disponibilitÃ© |
| `ReservationService` | CrÃ©er, annuler, confirmer, changer statut |
| `ReservationTaskService` | `@Scheduled` â€” expirer rÃ©servations automatiquement |
| `PaiementService` | Traitement des paiements |
| `NotificationService` | CrÃ©er et envoyer notifications |
| `DashboardService` | AgrÃ©gation statistiques (revenus, taux, etc.) |
| `HotelSearchService` | Recherche avancÃ©e par critÃ¨res |
| `FileStorageService` | Upload et stockage des images |

---

## ğŸŒ DIAGRAMME DE SÃ‰QUENCE GLOBAL â€” Vue d'ensemble de toute l'application

> Ce diagramme unique rÃ©sume les **9 flux principaux** de RimbestArch en un seul schÃ©ma.  
> Chaque groupe (`==`) correspond Ã  un scÃ©nario clÃ©. Les couleurs de participants restent cohÃ©rentes tout au long.

```plantuml
@startuml RimbestArch_MasterSequence
skinparam sequenceMessageAlign center
skinparam responseMessageBelowArrow true
skinparam sequenceGroupBorderColor #6C757D
skinparam sequenceGroupFontSize 13
skinparam sequenceGroupFontStyle bold
skinparam ParticipantBackgroundColor #EEF2FF
skinparam ParticipantBorderColor #4F46E5
skinparam ActorBackgroundColor #DBEAFE
skinparam DatabaseBackgroundColor #FEF3C7
skinparam DatabaseBorderColor #D97706
skinparam ArrowColor #374151
skinparam NoteBackgroundColor #F0FDF4
skinparam NoteBorderColor #16A34A

' â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
' PARTICIPANTS
' â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
actor "Visiteur\n/ Client\n/ Partenaire\n/ Admin" as U
participant "Angular SPA" as FE
participant "AppInterceptor\n(JWT)" as INT
participant "Spring Boot\nREST API" as BE
participant "Spring Security\n+ JwtUtils" as SEC
participant "Services\n(Business Logic)" as SVC
participant "Repositories\n(Spring Data JPA)" as REPO
participant "Scheduler\n(@Scheduled)" as SCHED
database "MySQL DB" as DB

' â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
' SEQ-1: AUTHENTIFICATION
' â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
== [Seq-1] Authentification JWT ==
U -> FE : Saisir email + motDePasse
FE -> BE : POST /api/auth/login\n{email, motDePasse}
BE -> SEC : authenticate(email, mdp)\n+ loadUserByUsername()
SEC -> DB : SELECT users WHERE email=?
DB --> SEC : UserDetails
SEC -> SEC : BCrypt.matches() + generateJwtToken()
SEC --> BE : JWT Token
BE --> FE : {token, role, userId, nom}
FE -> FE : localStorage.setItem('token')\nRouter â†’ /dashboard/{role}
FE --> U : âœ” Tableau de bord affichÃ©

' â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
' SEQ-2: INSCRIPTION
' â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
== [Seq-2] Inscription nouvel utilisateur ==
U -> FE : Remplir formulaire\n(Client ou Partenaire)
FE -> BE : POST /api/auth/register\n{nom, email, mdp, role, ...}
BE -> SVC : registerClient()\nOU registerPartenaire()
SVC -> SVC : BCrypt.encode(motDePasse)\nAssigner ROLE_{TYPE}
SVC -> DB : INSERT INTO users\nINSERT INTO {clients|partenaires}\nINSERT INTO user_roles
DB --> SVC : User crÃ©Ã© (id)
SVC --> BE : UserResponse
BE --> FE : HTTP 201
FE --> U : âœ” Redirection â†’ /login

' â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
' SEQ-3 & SEQ-4: GESTION CONTENU (Admin/Partenaire)
' â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
== [Seq-3/4] Gestion des DonnÃ©es (HÃ´tels, Chambres, Utilisateurs) ==
U -> FE : CRUD Hotel / Chambre / Utilisateur
FE -> INT : RequÃªte HTTP
INT -> BE : Ajouter\nAuthorization: Bearer {token}
BE -> SEC : VÃ©rifier JWT + @PreAuthorize\n(ROLE_ADMIN | ROLE_PARTENAIRE)
alt CrÃ©er Hotel (Partenaire)
  BE -> SVC : saveHotel(hotel, partenaireId)\n+ storeImages(files)
  SVC -> DB : INSERT INTO hotels\n+ images stockÃ©es dans /uploads/
else CrÃ©er Chambre
  BE -> SVC : saveChambre(chambre, hotelId)\nVÃ©rifier ownership
  SVC -> DB : INSERT INTO chambres
else GÃ©rer Utilisateurs (Admin only)
  BE -> SVC : registerUser() / updateUser()\n/ deleteUser() / toggleStatus()
  SVC -> DB : INSERT/UPDATE/DELETE users\n+ tables filles
end
DB --> SVC : EntitÃ© sauvÃ©e
SVC --> BE : DTO
BE --> FE : HTTP 200/201
FE --> U : âœ” OpÃ©ration rÃ©ussie

' â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
' SEQ-5: RECHERCHE HOTELES
' â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
== [Seq-5] Recherche & DÃ©couverte d'HÃ´tels ==
U -> FE : Saisir critÃ¨res\n(ville, dates, Ã©toiles, prix...)
FE -> BE : GET /api/search?\nville=...&dateArrivee=...&capacite=...
BE -> SVC : HotelSearchService\n.searchHotels(criteria, pageable)
SVC -> DB : SELECT hotels JOIN chambres\nWHERE actif=true\nAND disponible=true\nAND NOT EXISTS (conflits dates)\nAND critÃ¨res filtrÃ©s
DB --> SVC : Page<Hotel>
SVC --> BE : Page<HotelCardDTO>
BE --> FE : HTTP 200 rÃ©sultats paginÃ©s
FE --> U : Liste hÃ´tels + filtres dynamiques\n+ autocomplÃ©tion ville

' â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
' SEQ-6: RÃ‰SERVATION COMPLÃˆTE
' â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
== [Seq-6] Cycle complet d'une RÃ©servation ==
note over U, DB
  Statuts: EN_ATTENTE â†’ CONFIRMEE â†’ TERMINEE (scheduler)
  OU      EN_ATTENTE â†’ ANNULEE (refus/annulation client)
end note

U -> FE : Choisir chambre + dates\n(CLIENT uniquement)
FE -> BE : POST /api/reservations\n{chambreId, dateArrivee, dateDepart, nbPersonnes}
BE -> SVC : ReservationService\n.createReservation(dto, client)
SVC -> SVC : checkDisponibilite()\ngenerateReference("RES-{ts}")\ncalculatePrixTotal()
SVC -> DB : INSERT INTO reservations\n(statut=EN_ATTENTE)
SVC -> DB : INSERT INTO notifications\n(client=SUCCESS,\npartenaire=INFO)
BE --> FE : HTTP 201 {reference, prixTotal}
FE --> U : âœ” Confirmation rÃ©servation

U -> FE : Partenaire â†’ Confirmer / Refuser
FE -> BE : PUT /api/reservations/{id}/statut\n{activate: true|false}
BE -> SVC : confirmReservation()\nOU refuseReservation()
SVC -> DB : UPDATE reservations SET statut=?\nUPDATE chambres SET disponible=?
SVC -> DB : INSERT INTO notifications (client)
BE --> FE : HTTP 200 {statut: CONFIRMEE|ANNULEE}
FE --> U : âœ” Statut mis Ã  jour

' â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
' SEQ-7: SCHEDULER (tÃ¢che planifiÃ©e)
' â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
== [Seq-7] Expiration Automatique (Scheduler quotidien) ==
SCHED -> SCHED : @Scheduled cron\n"0 0 0 * * ?" (minuit)
SCHED -> REPO : findByStatut(CONFIRMEE)\nWHERE dateDepart < TODAY
REPO -> DB : SELECT rÃ©servations expirÃ©es
DB --> REPO : List<Reservation>
loop Chaque rÃ©servation expirÃ©e
  SCHED -> DB : UPDATE statut â†’ TERMINEE
  SCHED -> DB : UPDATE chambre SET disponible=true
  SCHED -> DB : INSERT notifications\n(client=SUCCESS, partenaire=INFO)
end
SCHED -> SCHED : log("{N} rÃ©servations terminÃ©es")

' â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
' SEQ-8: DASHBOARD
' â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
== [Seq-8] Tableau de Bord (adaptÃ© au rÃ´le) ==
U -> FE : Naviguer /dashboard
FE -> BE : GET /api/dashboard/{role}\n[JWT requis]
BE -> SVC : DashboardService\n.getAdminStats()\n.getPartenaireStats(user)\n.getClientStats(user)
SVC -> DB : COUNT hÃ´tels, users,\nrÃ©servations, revenus,\nhistorique 6 mois, chambres...
DB --> SVC : AgrÃ©gats numÃ©riques
SVC --> BE : DashboardResponse\n{stats, lastReservations,\nrecommendedHotels}
BE --> FE : HTTP 200
FE --> U : KPIs + graphiques\n+ derniÃ¨res rÃ©servations

' â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
' SEQ-9: PROFIL
' â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
== [Seq-9] Gestion du Profil & Mot de Passe ==
U -> FE : Modifier profil /profile/edit
FE -> BE : PUT /api/profile\n{nom, email, nomEntreprise?, siret?...}
BE -> SVC : findByEmail(jwt.email)\nupdateUser() â†’ instanceof dispatch\n(Client | Partenaire | Admin)
SVC -> DB : UPDATE users\nUPDATE partenaires (si Partenaire)
DB --> SVC : OK
BE --> FE : HTTP 200 UserResponse
FE --> U : âœ” Profil mis Ã  jour

U -> FE : Changer mot de passe /profile/password
FE -> BE : PUT /api/profile/password\n{ancien, nouveau}
BE -> SEC : BCrypt.matches(ancien, hash)
alt Correct
  BE -> DB : UPDATE motDePasse=BCrypt.encode(nouveau)
  BE --> FE : HTTP 200 âœ”
else Incorrect
  BE --> FE : HTTP 400 âœ—
end
FE --> U : RÃ©sultat affichÃ©

note over FE, BE
  Chaque requÃªte aprÃ¨s login passe par AppInterceptor
  qui injecte automatiquement: Authorization: Bearer {token}
  Spring Security vÃ©rifie le token sur chaque endpoint protÃ©gÃ©
end note
@enduml
```

---

## ğŸ› ï¸ Outils recommandÃ©s pour gÃ©nÃ©rer les diagrammes

| Outil | URL | Format |
|-------|-----|--------|
| **PlantUML Online** | [plantuml.com/plantuml](https://www.plantuml.com/plantuml/uml/) | `.puml` |
| **draw.io** | [draw.io](https://draw.io) | export PNG/SVG |
| **Lucidchart** | [lucidchart.com](https://lucidchart.com) | import PlantUML |
| **IntelliJ IDEA** | Plugin PlantUML | intÃ©grÃ© Ã  l'IDE |
| **VS Code** | Extension PlantUML | preview live |

> ğŸ’¡ **Conseil :** Copiez le bloc `@startuml RimbestArch_MasterSequence ... @enduml` dans [plantuml.com/plantuml](https://www.plantuml.com/plantuml/uml/) pour gÃ©nÃ©rer le diagramme global en PNG ou SVG haute rÃ©solution.
