<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h1 class="display-6">
      <i class="bi bi-search text-primary me-2"></i>Rechercher un séjour
    </h1>
    <p class="text-muted mb-0">Choisis un hôtel, des dates et une chambre disponible</p>
  </div>
</div>

<div *ngIf="errorMsg" class="alert alert-danger py-2">{{ errorMsg }}</div>

<!-- Formulaire recherche -->
<div class="card shadow-sm mb-4">
  <div class="card-body">
    <form [formGroup]="form" (ngSubmit)="loadHotels()">
      <div class="row g-3">
        <div class="col-md-3">
          <label class="form-label">Destination</label>
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-geo-alt"></i></span>
            <input class="form-control" formControlName="ville" placeholder="Ville..." />
          </div>
        </div>

        <div class="col-md-3">
          <label class="form-label">Pays</label>
          <input class="form-control" formControlName="pays" placeholder="Maroc, Mauritanie..." />
        </div>

        <div class="col-md-2">
          <label class="form-label">Budget Min</label>
          <input type="number" class="form-control" formControlName="prixMin" placeholder="MRU" />
        </div>

        <div class="col-md-2">
          <label class="form-label">Budget Max</label>
          <input type="number" class="form-control" formControlName="prixMax" placeholder="MRU" />
        </div>

        <div class="col-md-2">
          <label class="form-label">Étoiles</label>
          <select class="form-select" formControlName="etoiles">
            <option value="">Toutes</option>
            <option value="1">1★+</option>
            <option value="3">3★+</option>
            <option value="5">5★</option>
          </select>
        </div>

        <div class="col-md-3">
          <label class="form-label">Date début</label>
          <input type="date" class="form-control" formControlName="dateDebut" />
        </div>

        <div class="col-md-3">
          <label class="form-label">Date fin</label>
          <input type="date" class="form-control" formControlName="dateFin" />
        </div>

        <div class="col-md-2">
          <label class="form-label">Personnes</label>
          <input type="number" class="form-control" formControlName="nbPersonnes" />
        </div>

        <div class="col-md-4 d-flex align-items-center pt-4">
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="checkbox" formControlName="wifi" id="wifiCheck">
            <label class="form-check-label" for="wifiCheck">WiFi</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="checkbox" formControlName="climatisation" id="climCheck">
            <label class="form-check-label" for="climCheck">Clim</label>
          </div>
          <button class="btn btn-primary ms-auto px-4" type="submit" [disabled]="loadingHotels">
            <i class="bi bi-magic me-2"></i>{{ loadingHotels ? 'Recherche...' : 'Trouver le séjour idéal' }}
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

<div class="row g-4" *ngIf="hotels.length > 0">
  <div class="col-12">
    <h4 class="mb-4">Nos meilleures recommandations</h4>
  </div>
  <div class="col-xl-4 col-md-6" *ngFor="let h of hotels">
    <div class="premium-card h-100 overflow-hidden">
      <div class="position-relative overflow-hidden">
        <img
          [src]="h.allImageUrls && h.allImageUrls.length > 0 ? h.allImageUrls[0] : 'assets/images/hotel-placeholder.jpg'"
          class="card-img-top" alt="{{ h.nom }}"
          style="height: 220px; object-fit: cover; transition: transform 0.6s ease;">
        <div class="position-absolute top-0 end-0 m-3">
          <span class="badge glass-effect text-primary border-primary border-opacity-25 px-3 py-2 shadow-sm">
            <i class="bi bi-star-fill text-warning me-1"></i>{{ h.etoiles }}
          </span>
        </div>
        <div class="position-absolute bottom-0 start-0 m-3">
          <span class="badge bg-primary px-3 py-2 rounded-pill shadow-sm animate__animated animate__fadeInLeft">
            Dès {{ h.prixParNuit || '---' }} MRU
          </span>
        </div>
      </div>
      <div class="card-body p-4">
        <h5 class="fw-bold text-main mb-1">{{ h.nom }}</h5>
        <p class="text-muted small mb-3"><i class="bi bi-geo-alt text-primary me-1"></i>{{ h.ville }}, {{ h.pays }}</p>

        <p class="card-text text-secondary small text-truncate-3 mb-4">
          {{ h.description || 'Profitez d\'un séjour exceptionnel dans cet établissement sélectionné pour vous.' }}
        </p>

        <div class="d-flex flex-wrap gap-2 mb-4">
          <span class="badge bg-light text-primary border border-primary border-opacity-10"
            *ngIf="h.equipementsHotel?.toLowerCase()?.includes('wifi')">
            <i class="bi bi-wifi me-1"></i>WiFi
          </span>
          <span class="badge bg-light text-primary border border-primary border-opacity-10"
            *ngIf="h.equipementsHotel?.toLowerCase()?.includes('pool') || h.equipementsHotel?.toLowerCase()?.includes('piscine')">
            <i class="bi bi-water me-1"></i>Piscine
          </span>
        </div>

        <div class="d-grid gap-2">
          <button class="btn btn-premium-gradient rounded-pill py-2 text-white shadow-lg" (click)="pickHotel(h)">
            Voir les chambres <i class="bi bi-arrow-right ms-2"></i>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal ou Section de sélection de chambre quand un hôtel est choisi -->
<div class="mt-5" *ngIf="selectedHotel">
  <div class="card shadow-lg border-0 rounded-4 overflow-hidden animate__animated animate__fadeInUp">
    <div class="card-header bg-primary text-white p-4">
      <div class="d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Chambres disponibles chez <span class="fw-bold">{{ selectedHotel.nom }}</span></h5>
        <button class="btn-close btn-close-white" (click)="selectedHotel = null"></button>
      </div>
    </div>
    <div class="card-body p-4">
      <div *ngIf="loadingRooms" class="text-center py-5">
        <div class="spinner-border text-primary" role="status"></div>
        <div class="mt-2">Recherche des chambres disponibles...</div>
      </div>

      <div *ngIf="!loadingRooms && chambres.length === 0" class="text-center py-5">
        <i class="bi bi-calendar-x display-4 text-muted opacity-50"></i>
        <h6 class="mt-3">Aucune chambre disponible pour ces critères dans cet hôtel.</h6>
      </div>

      <div class="row g-4" *ngIf="!loadingRooms && chambres.length > 0">
        <div class="col-md-6" *ngFor="let c of chambres">
          <div class="card border h-100 transition-hover" [class.border-primary]="selectedChambre?.id === c.id">
            <div class="card-body d-flex justify-content-between align-items-center">
              <div>
                <h6 class="fw-bold mb-1">Chambre {{ c.numero || ('#'+c.id) }}</h6>
                <p class="text-muted small mb-0">{{ c.type }} • {{ c.capacite }} pers.</p>
                <div class="mt-2">
                  <span class="text-primary fw-bold">{{ c.prixParNuit }} MRU</span><small class="text-muted"> /
                    nuit</small>
                </div>
              </div>
              <button class="btn btn-outline-primary rounded-pill px-4" (click)="viewRoomDetails(c)">
                Voir détails
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Section de réservation inline supprimée car on passe par la page détails -->
    </div>
  </div>
</div>

<div *ngIf="!loadingHotels && hotels.length === 0" class="text-center py-5 mt-5">
  <i class="bi bi-search display-1 text-muted opacity-25"></i>
  <h3 class="mt-4 text-muted">Ajustez vos filtres pour trouver votre séjour</h3>
  <p class="text-secondary">Nous n'avons trouvé aucun résultat correspondant exactement à vos critères.</p>
</div>