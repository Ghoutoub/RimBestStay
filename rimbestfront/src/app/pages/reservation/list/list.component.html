<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h1 class="display-6">
      <i class="bi bi-calendar-check text-primary me-2"></i>Réservations
    </h1>
    <p class="text-muted mb-0">Suivi des demandes et états de réservation</p>
  </div>

  <a *ngIf="auth.hasRole('CLIENT')" class="btn btn-primary" routerLink="/reservations/add">
    <i class="bi bi-plus-circle me-1"></i>Nouvelle réservation
  </a>
</div>

<div class="card shadow-sm mb-4">
  <div class="card-body">
    <form [formGroup]="form" (ngSubmit)="onSearch()">
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Recherche</label>
          <input class="form-control" formControlName="search" placeholder="Hotel, chambre, client..." />
        </div>

        <div class="col-md-3">
          <label class="form-label">Statut</label>
          <select class="form-select" formControlName="statut">
            <option value="">Tous</option>
            <option value="EN_ATTENTE">En attente</option>
            <option value="CONFIRMEE">Confirmée</option>
            <option value="REFUSEE">Refusée</option>
            <option value="ANNULEE">Annulée</option>
          </select>
        </div>

        <div class="col-md-1 d-flex align-items-end">
          <button class="btn btn-primary w-100" [disabled]="loading" type="submit">
            <i class="bi bi-search"></i>
          </button>
        </div>

        <div class="col-md-2 d-flex align-items-end">
          <button class="btn btn-outline-secondary w-100" type="button" (click)="clearFilters()" [disabled]="loading">
            <i class="bi bi-x-circle me-1"></i>Reset
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

<div *ngIf="errorMsg" class="alert alert-danger py-2">{{ errorMsg }}</div>
<div *ngIf="loading" class="alert alert-info py-2">
  <i class="bi bi-arrow-repeat me-2"></i>Chargement...
</div>

<!-- Admin/Partenaire View -->
<div *ngIf="auth.hasRole('ADMIN') || auth.hasRole('PARTENAIRE')">
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card bg-primary text-white shadow-sm border-0">
        <div class="card-body d-flex justify-content-between align-items-center">
          <div>
            <h6 class="mb-0 text-white-50">Total Réservations</h6>
            <h3 class="mb-0">{{ totalElements }}</h3>
          </div>
          <i class="bi bi-journal-text fs-1 opacity-50"></i>
        </div>
      </div>
    </div>
  </div>

  <div class="card shadow border-0">
    <div class="card-header bg-white">
      <h5 class="mb-0"><i class="bi bi-list me-2"></i>Liste des Demandes</h5>
    </div>

    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th class="ps-4">Réf</th>
              <th>Hôtel & Chambre</th>
              <th>Dates</th>
              <th>Client</th>
              <th>Statut</th>
              <th>Prix</th>
              <th class="pe-4 text-end">Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let r of reservations">
              <td class="ps-4 fw-semibold text-primary">#{{ r.reference || r.id }}</td>
              <td>
                <div class="fw-bold">{{ r.hotelNom || ('Hotel #' + r.hotelId) }}</div>
                <div class="text-muted small">Chambre {{ r.chambreNumero || ('#' + r.chambreId) }} <span
                    class="badge bg-light text-dark ms-1">{{ r.chambreType }}</span></div>
              </td>
              <td>
                <div class="small">
                  <div><i class="bi bi-box-arrow-in-right text-success me-1"></i>{{ r.dateDebut }}</div>
                  <div><i class="bi bi-box-arrow-right text-danger me-1"></i>{{ r.dateFin }}</div>
                </div>
              </td>
              <td>
                <div class="small">
                  <div class="fw-semibold">{{ r.clientNom || '-' }}</div>
                  <div class="text-muted">{{ r.clientEmail || '' }}</div>
                </div>
              </td>
              <td>
                <span class="badge" [ngClass]="badgeClass(r.statut)">{{ r.statut }}</span>
              </td>
              <td class="fw-bold">{{ r.prixTotal ?? '-' }} <small class="fw-normal text-muted">MRU</small></td>
              <td class="pe-4 text-end">
                <a class="btn btn-sm btn-outline-primary rounded-pill shadow-sm px-3"
                  [routerLink]="['/reservation/details', r.id]">
                  <i class="bi bi-eye me-1"></i> Gérer
                </a>
              </td>
            </tr>
            <tr *ngIf="!loading && reservations.length === 0">
              <td colspan="7" class="text-center py-5 text-muted">
                <i class="bi bi-calendar-x display-1 opacity-25"></i>
                <h5 class="mt-3">Aucune réservation trouvée</h5>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Client View -->
<div *ngIf="auth.hasRole('CLIENT')">
  <ul class="nav nav-pills mb-4">
    <li class="nav-item">
      <a class="nav-link" [class.active]="form.get('statut')?.value === ''" (click)="setStatut('')"
        style="cursor: pointer;">Toutes</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" [class.active]="form.get('statut')?.value === 'CONFIRMEE'" (click)="setStatut('CONFIRMEE')"
        style="cursor: pointer;">Confirmées</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" [class.active]="form.get('statut')?.value === 'EN_ATTENTE'" (click)="setStatut('EN_ATTENTE')"
        style="cursor: pointer;">En attente</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" [class.active]="form.get('statut')?.value === 'ANNULEE'" (click)="setStatut('ANNULEE')"
        style="cursor: pointer;">Annulées</a>
    </li>
  </ul>

  <div class="row g-4">
    <div class="col-md-6 col-lg-4" *ngFor="let r of reservations">
      <div class="card h-100 shadow-sm border-0 rounded-4">
        <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center pt-3 pb-0">
          <span class="badge" [ngClass]="badgeClass(r.statut)">{{ r.statut }}</span>
          <span class="text-muted small">Réf: #{{ r.reference || r.id }}</span>
        </div>
        <div class="card-body">
          <h5 class="card-title text-primary"><i class="bi bi-building me-2"></i>{{ r.hotelNom || 'Hôtel' }}</h5>
          <h6 class="card-subtitle mb-4 text-muted"><i class="bi bi-door-closed me-2"></i>Chambre {{ r.chambreNumero }}
            <span class="badge bg-light text-dark ms-1">{{ r.chambreType }}</span>
          </h6>

          <div class="bg-light rounded p-3 mb-3">
            <div class="d-flex justify-content-between mb-2 small">
              <div class="text-muted"><i class="bi bi-box-arrow-in-right text-success me-1"></i> Arrivée</div>
              <div class="fw-bold">{{ r.dateDebut }}</div>
            </div>
            <div class="d-flex justify-content-between small">
              <div class="text-muted"><i class="bi bi-box-arrow-right text-danger me-1"></i> Départ</div>
              <div class="fw-bold">{{ r.dateFin }}</div>
            </div>
          </div>

          <div class="d-flex justify-content-between align-items-center mt-auto pt-2">
            <span class="text-muted small">Montant total</span>
            <span class="fs-4 fw-bold text-primary">{{ r.prixTotal }} <small class="fs-6 fw-normal">MRU</small></span>
          </div>
        </div>
        <div class="card-footer bg-white border-0 pb-3 pt-0 d-grid">
          <a class="btn btn-outline-primary rounded-pill" [routerLink]="['/reservation/details', r.id]">
            Voir les détails <i class="bi bi-arrow-right ms-1"></i>
          </a>
        </div>
      </div>
    </div>
    <div *ngIf="!loading && reservations.length === 0" class="col-12 text-center py-5 text-muted">
      <i class="bi bi-calendar-x display-1 opacity-25"></i>
      <h5 class="mt-3">Aucune réservation pour ce statut</h5>
      <button *ngIf="form.get('statut')?.value !== ''" (click)="setStatut('')"
        class="btn btn-outline-secondary mt-3">Voir toutes les réservations</button>
    </div>
  </div>
</div>

<nav class="mt-4" *ngIf="totalPages > 1">
  <ul class="pagination justify-content-center">
    <li class="page-item" [class.disabled]="currentPage === 0">
      <button class="page-link" (click)="load(currentPage - 1)" [disabled]="currentPage === 0">
        <i class="bi bi-chevron-left"></i>
      </button>
    </li>

    <li class="page-item" *ngFor="let p of pagesArray()" [class.active]="p === currentPage">
      <button class="page-link" (click)="load(p)">{{ p + 1 }}</button>
    </li>

    <li class="page-item" [class.disabled]="currentPage === totalPages - 1">
      <button class="page-link" (click)="load(currentPage + 1)" [disabled]="currentPage === totalPages - 1">
        <i class="bi bi-chevron-right"></i>
      </button>
    </li>
  </ul>
</nav>